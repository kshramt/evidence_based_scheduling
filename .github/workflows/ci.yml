name: ci
on: [push]
jobs:
  set-vars:
    runs-on: ubuntu-latest
    outputs:
      ref-b64: ${{ steps.vars.outputs.ref-b64 }}
      tmp-dir: ${{ steps.vars.outputs.tmp-dir }}
      host-arch: ${{ steps.vars.outputs.host-arch }}
      host-os: ${{ steps.vars.outputs.host-os }}
    steps:
      - id: vars
        run: |
          set -xv
          set -o errexit
          set -o pipefail
          {
          echo "ref-b64=$(echo "${{ github.ref }}" | base64 --wrap 0 | sed -e 's/[-=/]/_/g')"
          echo "tmp-dir=$(mktemp -d)"
          echo "host-arch=$(docker version --format '{{ (index .Server.Components 0).Details.Arch }}')"
          echo "host-os=$(docker version --format '{{ (index .Server.Components 0).Details.Os }}')"
          } >> "$GITHUB_OUTPUT"
  shell-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install shell linters
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y xz-utils

          shellcheck_version=0.10.0
          shfmt_version=3.10.0

          tmp_dir=$(mktemp -d)
          curl -sSfL "https://github.com/koalaman/shellcheck/releases/download/v${shellcheck_version}/shellcheck-v${shellcheck_version}.linux.x86_64.tar.xz" -o "${tmp_dir}/shellcheck.tar.xz"
          tar -xf "${tmp_dir}/shellcheck.tar.xz" -C "${tmp_dir}"
          sudo install -m 0755 "${tmp_dir}/shellcheck-v${shellcheck_version}/shellcheck" /usr/local/bin/shellcheck

          curl -sSfL "https://github.com/mvdan/sh/releases/download/v${shfmt_version}/shfmt_v${shfmt_version}_linux_amd64" -o "${tmp_dir}/shfmt"
          sudo install -m 0755 "${tmp_dir}/shfmt" /usr/local/bin/shfmt
      - name: Run shellcheck
        run: |
          set -euxo pipefail
          mapfile -t files < <(find scripts db client -type f -name '*.sh' -not -path '*/node_modules/*' -not -path '*/.venv/*')
          shellcheck "${files[@]}"
      - name: Run shfmt
        run: |
          set -euxo pipefail
          mapfile -t files < <(find scripts db client -type f -name '*.sh' -not -path '*/node_modules/*' -not -path '*/.venv/*')
          shfmt -d "${files[@]}"
  build-images:
    if: github.actor == 'dependabot[bot]' || github.actor == github.repository_owner
    permissions:
      contents: read
      packages: write
    needs: [set-vars]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [linux]
        arch: [amd64]
        # arch: [amd64, arm64]
    steps:
      # - name: Free up space
      #   run: sudo rm -fr /opt/ghc /usr/share/dotnet /usr/local/lib/android || true
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: scripts/build_test_push.sh ${{ github.sha }} ${{ needs.set-vars.outputs.ref-b64 }} ${{ matrix.os }} ${{ matrix.arch }} ${{ github.ref }} ${{ github.run_number }} ${{ needs.set-vars.outputs.host-arch }} ${{ needs.set-vars.outputs.host-os }}
  build-manifests:
    if: github.actor == 'dependabot[bot]' || github.actor == github.repository_owner
    permissions:
      contents: read
      packages: write
    needs: [build-images]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: scripts/publish_manifests.sh ${{ github.sha }} ${{ github.ref }} ${{ github.run_number }}
