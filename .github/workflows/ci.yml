name: ci
on: [push]
jobs:
  set-vars:
    runs-on: ubuntu-latest
    outputs:
      ref-b64: steps.vars.outputs.ref-b64
      tmp-dir: steps.vars.outputs.tmp-dir
    steps:
    - id: vars
      run: |
        echo ::set-output name=ref-b64::"$(echo "${{ github.ref }}" | base64 --wrap 0 | sed -e 's/=//g')"
        echo ::set-output name=tmp-dir::"$(mktemp -d)"
  build-images:
    needs: [set-vars]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
    - uses: actions/checkout@v3
    - uses: docker/setup-buildx-action@v2
    - uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - run: sha=${{ github.sha }} ref_b64=${{ needs.set-vars.outputs.ref-b64 }} docker buildx bake --file bake.hcl {prod,test_client,test_api}/${{ matrix.platform }}
    #
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_api/${{ matrix.platform }}:${{ github.sha }} .venv/bin/python3 -m pyflakes api
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_api/${{ matrix.platform }}:${{ github.sha }} .venv/bin/python3 -m mypy --check-untyped-defs api
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_api/${{ matrix.platform }}:${{ github.sha }} .venv/bin/python3 -m black --check api
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_api/${{ matrix.platform }}:${{ github.sha }} .venv/bin/python3 -m isort --check-only api
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_api/${{ matrix.platform }}:${{ github.sha }} .venv/bin/python3 -m pytest
    #
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_client/${{ matrix.platform }}:${{ github.sha }} node_modules/.bin/react-scripts test --ci --watchAll false
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_client/${{ matrix.platform }}:${{ github.sha }} node_modules/.bin/eslint --max-warnings 0 src
    - run: docker run ghcr.io/kshramt/evidence_based_scheduling/test_client/${{ matrix.platform }}:${{ github.sha }} node_modules/.bin/prettier --check src
    #
    - if: ${{ github.ref == 'refs/heads/main' }}
      run: docker pull ghcr.io/kshramt/evidence_based_scheduling/${{ matrix.platform }}:${{ github.sha }}
    - if: ${{ github.ref == 'refs/heads/main' }}
      run: docker tag ghcr.io/kshramt/evidence_based_scheduling/${{ matrix.platform }}:${{ github.sha }} ghcr.io/kshramt/evidence_based_scheduling/${{ matrix.platform }}:latest
    - if: ${{ github.ref == 'refs/heads/main' }}
      run: docker push ghcr.io/kshramt/evidence_based_scheduling/${{ matrix.platform }}:latest
  build-manifests:
    needs: [build-manifests]
    runs-on: ubuntu-latest
    steps:
    - run: docker manifest create ghcr.io/kshramt/evidence_based_scheduling{,/linux{amd64,arm64}}:${{ github.sha }}
    - run: docker manifest push ghcr.io/kshramt/evidence_based_scheduling:${{ github.sha }}
    - if: ${{ github.ref == 'refs/heads/main' }}
      run: docker tag ghcr.io/kshramt/evidence_based_scheduling:${{ github.sha }} ghcr.io/kshramt/evidence_based_scheduling:latest
    - if: ${{ github.ref == 'refs/heads/main' }}
      run: docker push ghcr.io/kshramt/evidence_based_scheduling:latest
